test:
  override:
    - RAILS_ENV=test bundle exec rspec -r rspec_junit_formatter --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml
machine:
  ruby:
    version: 2.4.3
  services:
    - 'redis'
database:
  post:
    - bundle exec rake elasticsearch:import_opportunities
    - bundle exec rake elasticsearch:import_subscriptions
    - |
      echo "Sleeping until Elasticsearch does not have red status"
      until [ "$(curl localhost:9200/_cluster/health | jq --raw-output .status)" != "red" ]; do
        echo "Sleeping..."
        sleep 5
      done
      echo "Elasticsearch does not have red status"
dependencies:
  post:
    - wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.2.2.tar.gz
    - tar -xvf elasticsearch-5.2.2.tar.gz
    - elasticsearch-5.2.2/bin/elasticsearch: {background: true}
    # Make sure that Elasticsearch is up before running tests:
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/
    
